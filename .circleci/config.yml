version: 2.1

orbs:
  aws-cli: circleci/aws-cli@3.1.1
  kubernetes: circleci/kubernetes@1.3.1

executors:
  docker-executor:
    docker:
      - image: cimg/base:2023.03
        auth:
          username: $DOCKER_USERNAME
          password: $DOCKER_PASSWORD

jobs:
  test-frontend:
    docker:
      - image: cimg/node:18.16
    steps:
      - checkout
      - restore_cache:
          keys:
            - frontend-deps-{{ checksum "frontend/package-lock.json" }}
      - run:
          name: Install dependencies
          command: cd frontend && npm ci
      - save_cache:
          key: frontend-deps-{{ checksum "frontend/package-lock.json" }}
          paths:
            - frontend/node_modules
      - run:
          name: Run tests
          command: cd frontend && npm test

  test-backend:
    docker:
      - image: cimg/node:18.16
    steps:
      - checkout
      - restore_cache:
          keys:
            - backend-deps-{{ checksum "backend/package-lock.json" }}
      - run:
          name: Install dependencies
          command: cd backend && npm ci
      - save_cache:
          key: backend-deps-{{ checksum "backend/package-lock.json" }}
          paths:
            - backend/node_modules
      - run:
          name: Run tests
          command: cd backend && npm test

  build-and-push-images:
    executor: docker-executor
    steps:
      - checkout
      - setup_remote_docker:
          version: 20.10.14
      - run:
          name: Login to Docker Hub
          command: echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
      - run:
          name: Build and push frontend image
          command: |
            cd frontend
            docker build -t $DOCKER_USERNAME/nebulance-frontend:${CIRCLE_SHA1:0:7} -t $DOCKER_USERNAME/nebulance-frontend:latest .
            docker push $DOCKER_USERNAME/nebulance-frontend:${CIRCLE_SHA1:0:7}
            docker push $DOCKER_USERNAME/nebulance-frontend:latest
      - run:
          name: Build and push backend image
          command: |
            cd backend
            docker build -t $DOCKER_USERNAME/nebulance-backend:${CIRCLE_SHA1:0:7} -t $DOCKER_USERNAME/nebulance-backend:latest .
            docker push $DOCKER_USERNAME/nebulance-backend:${CIRCLE_SHA1:0:7}
            docker push $DOCKER_USERNAME/nebulance-backend:latest

  deploy-to-dev:
    docker:
      - image: cimg/python:3.9
    steps:
      - checkout
      - aws-cli/setup:
          profile-name: default
      - run:
          name: Update kubeconfig
          command: |
            aws eks update-kubeconfig --name eks-nebulance --region $AWS_REGION
      - kubernetes/install-kubectl
      - run:
          name: Install Helm
          command: |
            curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
      - run:
          name: Deploy to dev environment
          command: |
            helm upgrade --install nebulance ./helm/nebulance \
              --values ./environments/dev/values.yaml \
              --set frontend.image.tag=${CIRCLE_SHA1:0:7} \
              --set backend.image.tag=${CIRCLE_SHA1:0:7}

  deploy-to-prod:
    docker:
      - image: cimg/python:3.9
    steps:
      - checkout
      - aws-cli/setup:
          profile-name: default
      - run:
          name: Update kubeconfig
          command: |
            aws eks update-kubeconfig --name eks-nebulance --region $AWS_REGION
      - kubernetes/install-kubectl
      - run:
          name: Install Helm
          command: |
            curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
      - run:
          name: Deploy to production environment
          command: |
            helm upgrade --install nebulance ./helm/nebulance \
              --values ./environments/prod/values.yaml \
              --set frontend.image.tag=${CIRCLE_SHA1:0:7} \
              --set backend.image.tag=${CIRCLE_SHA1:0:7}

workflows:
  version: 2
  build-test-deploy:
    jobs:
      - test-frontend
      - test-backend
      - build-and-push-images:
          requires:
            - test-frontend
            - test-backend
          context:
            - docker-hub-creds
      - deploy-to-dev:
          requires:
            - build-and-push-images
          context:
            - aws-dev
          filters:
            branches:
              only:
                - develop
                - main
      - approve-prod-deployment:
          type: approval
          requires:
            - deploy-to-dev
          filters:
            branches:
              only: main
      - deploy-to-prod:
          requires:
            - approve-prod-deployment
          context:
            - aws-prod
          filters:
            branches:
              only: main